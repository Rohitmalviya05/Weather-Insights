{% extends "base.html" %}

{% block title %}Health Alerts{% endblock %}

{% block content %}
<!-- Toast for notifications -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1050">
    <div id="healthToast" class="toast hide" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header bg-primary text-white">
            <i class="fas fa-info-circle me-2"></i>
            <strong class="me-auto">Health Alerts</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage">
            Health data updated successfully!
        </div>
    </div>
</div>
<!-- Hero Section -->
<div class="hero-section">
    <div class="container">
        <div class="row">
            <div class="col-lg-8 mx-auto text-center">
                <h1 class="display-4 fw-bold mb-3">Weather Health Alerts</h1>
                <p class="lead">Personalized health alerts based on weather conditions, air quality, and pollen levels.</p>
            </div>
        </div>
    </div>
</div>

<!-- Search Section -->
<div class="search-section">
    <div class="container">
        <div class="card border-0 shadow search-card">
            <div class="card-body p-4">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="input-group">
                            <input type="text" class="form-control search-input" id="locationSearch" placeholder="Search for a city or location..." aria-label="Search for a city">
                            <button class="btn btn-primary search-btn" type="button" id="searchButton">
                                <i class="fas fa-search me-1"></i>Search
                            </button>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <select class="form-select" id="ageGroupSelect">
                            <option value="child">Children (0-12)</option>
                            <option value="teen">Teenagers (13-18)</option>
                            <option value="adult" selected>Adults (19-64)</option>
                            <option value="senior">Seniors (65+)</option>
                        </select>
                    </div>
                </div>
                
                <div class="row mt-3">
                    <div class="col-12">
                        <div class="health-conditions">
                            <span class="small text-muted me-2">Health Conditions:</span>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="asthmaCondition" value="asthma">
                                <label class="form-check-label" for="asthmaCondition">Asthma</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="allergyCondition" value="allergies">
                                <label class="form-check-label" for="allergyCondition">Allergies</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="heartCondition" value="heart_disease">
                                <label class="form-check-label" for="heartCondition">Heart Disease</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="respiratoryCondition" value="respiratory_illness">
                                <label class="form-check-label" for="respiratoryCondition">Respiratory Illness</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="arthritisCondition" value="arthritis">
                                <label class="form-check-label" for="arthritisCondition">Arthritis</label>
                            </div>
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" id="migraineCondition" value="migraines">
                                <label class="form-check-label" for="migraineCondition">Migraines</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Health Alerts Section -->
<div class="container mt-4">
    <div class="row">
        <div class="col-lg-8">
            <!-- Current Health Alerts -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h3 class="card-title mb-0">Today's Health Alerts</h3>
                        <div class="d-flex align-items-center">
                            <div class="location-name text-muted me-3">Loading location...</div>
                            <button id="refreshButton" class="btn btn-sm btn-outline-primary" title="Refresh data">
                                <i class="fas fa-sync-alt"></i> Refresh
                            </button>
                        </div>
                    </div>
                    <div id="healthAlertsContainer">
                        <div class="text-center p-5">
                            <i class="fas fa-heartbeat text-primary fs-1 mb-3"></i>
                            <p>Select a location to view health alerts</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Weather Impact on Health -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h3 class="card-title mb-3">Weather Impact on Health</h3>
                    <div id="weatherImpactContainer">
                        <div class="row row-cols-1 row-cols-md-3 g-4">
                            <div class="col">
                                <div class="card h-100 border-0 shadow-sm">
                                    <div class="card-body p-3">
                                        <h5 class="card-title"><i class="fas fa-thermometer-half text-primary me-2"></i>Temperature</h5>
                                        <div class="temp-impact">
                                            <div class="placeholder-glow">
                                                <span class="placeholder col-7"></span>
                                                <span class="placeholder col-4"></span>
                                                <span class="placeholder col-4"></span>
                                                <span class="placeholder col-6"></span>
                                                <span class="placeholder col-8"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col">
                                <div class="card h-100 border-0 shadow-sm">
                                    <div class="card-body p-3">
                                        <h5 class="card-title"><i class="fas fa-wind text-primary me-2"></i>Humidity & Pressure</h5>
                                        <div class="pressure-impact">
                                            <div class="placeholder-glow">
                                                <span class="placeholder col-7"></span>
                                                <span class="placeholder col-4"></span>
                                                <span class="placeholder col-4"></span>
                                                <span class="placeholder col-6"></span>
                                                <span class="placeholder col-8"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col">
                                <div class="card h-100 border-0 shadow-sm">
                                    <div class="card-body p-3">
                                        <h5 class="card-title"><i class="fas fa-sun text-primary me-2"></i>UV Exposure</h5>
                                        <div class="uv-impact">
                                            <div class="placeholder-glow">
                                                <span class="placeholder col-7"></span>
                                                <span class="placeholder col-4"></span>
                                                <span class="placeholder col-4"></span>
                                                <span class="placeholder col-6"></span>
                                                <span class="placeholder col-8"></span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Health Trends Analysis -->
<div class="card border-0 shadow-sm mb-4">
    <div class="card-body p-4">
        <h3 class="card-title mb-3">Health Trends Analysis</h3>
        <div id="healthTrendsContainer">
            <div class="row">
                <div class="col-md-6 mb-4">
                    <h5>Temperature Trends</h5>
                    <img src="" alt="Temperature Trends" id="tempTrendChart" class="img-fluid rounded">
                </div>
                <div class="col-md-6 mb-4">
                    <h5>Humidity Analysis</h5>
                    <img src="" alt="Humidity Analysis" id="humidityChart" class="img-fluid rounded">
                </div>
            </div>
            <div class="row mt-3">
                <div class="col-12">
                    <h5>Health Risk Metrics</h5>
                    <div id="healthMetrics" class="row g-3">
                        <!-- Metrics will be populated here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Weekly Health Forecast -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h3 class="card-title mb-3">Weekly Health Forecast</h3>
                    <div id="weeklyHealthForecast">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Day</th>
                                        <th>Weather</th>
                                        <th>Air Quality</th>
                                        <th>Pollen</th>
                                        <th>UV Index</th>
                                        <th>Health Risk</th>
                                    </tr>
                                </thead>
                                <tbody id="forecastTableBody">
                                    <tr>
                                        <td colspan="6" class="text-center">Loading forecast data...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <!-- Today's Conditions -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h4 class="card-title mb-3">Current Conditions</h4>
                    <div id="currentConditions">
                        <div class="placeholder-glow">
                            <span class="placeholder col-6"></span>
                            <span class="placeholder col-8"></span>
                            <span class="placeholder col-7"></span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Air Quality -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h4 class="card-title mb-3">Air Quality</h4>
                    <div id="airQualityContainer">
                        <div class="text-center">
                            <div class="placeholder-glow">
                                <span class="placeholder col-6"></span>
                                <span class="placeholder col-8"></span>
                                <span class="placeholder col-7"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pollen Levels -->
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-body p-4">
                    <h4 class="card-title mb-3">Pollen Levels</h4>
                    <div id="pollenContainer">
                        <div class="text-center">
                            <div class="placeholder-glow">
                                <span class="placeholder col-6"></span>
                                <span class="placeholder col-8"></span>
                                <span class="placeholder col-7"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Personalized Health Tips -->
            <div class="card border-0 shadow-sm">
                <div class="card-body p-4">
                    <h4 class="card-title mb-3">Health Tips</h4>
                    <div id="healthTipsContainer">
                        <div class="text-center">
                            <div class="placeholder-glow">
                                <span class="placeholder col-6"></span>
                                <span class="placeholder col-8"></span>
                                <span class="placeholder col-7"></span>
                                <span class="placeholder col-9"></span>
                                <span class="placeholder col-5"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Global variables
    let currentLocationData = {};
    
    // DOM Elements
    const locationNameElems = document.querySelectorAll('.location-name');
    const locationSearchInput = document.getElementById('locationSearch');
    const searchButton = document.getElementById('searchButton');
    const ageGroupSelect = document.getElementById('ageGroupSelect');
    const healthConditionCheckboxes = document.querySelectorAll('.health-conditions input[type="checkbox"]');
    const healthAlertsContainer = document.getElementById('healthAlertsContainer');
    const currentConditionsContainer = document.getElementById('currentConditions');
    const airQualityContainer = document.getElementById('airQualityContainer');
    const pollenContainer = document.getElementById('pollenContainer');
    const healthTipsContainer = document.getElementById('healthTipsContainer');
    const tempImpactContainer = document.querySelector('.temp-impact');
    const pressureImpactContainer = document.querySelector('.pressure-impact');
    const uvImpactContainer = document.querySelector('.uv-impact');
    const forecastTableBody = document.getElementById('forecastTableBody');
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', () => {
        // Set up event listeners
        searchButton.addEventListener('click', handleSearch);
        locationSearchInput.addEventListener('keypress', e => {
            if (e.key === 'Enter') {
                handleSearch();
            }
        });
        
        // Add refresh button listener
        const refreshButton = document.getElementById('refreshButton');
        if (refreshButton) {
            refreshButton.addEventListener('click', function() {
                // Add rotation animation to refresh icon
                const refreshIcon = refreshButton.querySelector('i');
                refreshIcon.classList.add('fa-spin');
                
                // Update data based on current location
                if (currentLocationData.lat && currentLocationData.lon) {
                    getHealthDataByCoordinates(currentLocationData.lat, currentLocationData.lon);
                    
                    // Remove spinning animation after 1.5 seconds
                    setTimeout(() => {
                        refreshIcon.classList.remove('fa-spin');
                    }, 1500);
                } else {
                    // If no location data, try to get user's location
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            const { latitude, longitude } = position.coords;
                            getHealthDataByCoordinates(latitude, longitude);
                            
                            // Remove spinning animation
                            setTimeout(() => {
                                refreshIcon.classList.remove('fa-spin');
                            }, 1500);
                        },
                        error => {
                            console.error('Geolocation error:', error);
                            // Use default location if geolocation fails
                            getHealthDataByCoordinates(51.5074, -0.1278); // London coordinates
                            
                            // Remove spinning animation
                            setTimeout(() => {
                                refreshIcon.classList.remove('fa-spin');
                            }, 1500);
                        }
                    );
                }
            });
        }
        
        // Add listeners for age and condition changes
        ageGroupSelect.addEventListener('change', updateHealthData);
        healthConditionCheckboxes.forEach(checkbox => {
            checkbox.addEventListener('change', updateHealthData);
        });
        
        // Get user's location
        navigator.geolocation.getCurrentPosition(
            position => {
                const { latitude, longitude } = position.coords;
                getHealthDataByCoordinates(latitude, longitude);
            },
            error => {
                console.error('Geolocation error:', error);
                // Use default location if geolocation fails
                getHealthDataByCoordinates(51.5074, -0.1278); // London coordinates
            }
        );
    });
    
    // Show loading elements
    function showLoading() {
        // Clear previous results
        healthAlertsContainer.innerHTML = `
            <div class="text-center p-4">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-3">Loading health alerts...</p>
            </div>
        `;
        
        // Reset other containers to loading state
        currentConditionsContainer.innerHTML = `<div class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div></div>`;
        airQualityContainer.innerHTML = `<div class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div></div>`;
        pollenContainer.innerHTML = `<div class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div></div>`;
        healthTipsContainer.innerHTML = `<div class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div></div>`;
        
        // Reset impact containers
        tempImpactContainer.innerHTML = `<div class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div></div>`;
        pressureImpactContainer.innerHTML = `<div class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div></div>`;
        uvImpactContainer.innerHTML = `<div class="text-center"><div class="spinner-border spinner-border-sm text-primary"></div></div>`;
        
        // Reset forecast table
        forecastTableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center">
                    <div class="spinner-border spinner-border-sm text-primary"></div>
                    <span class="ms-2">Loading forecast data...</span>
                </td>
            </tr>
        `;
    }
    
    // Handle search button click
    function handleSearch() {
        const location = locationSearchInput.value.trim();
        if (location) {
            showLoading();
            
            // Geocode the location to get coordinates
            fetch(`/api/geocode?q=${encodeURIComponent(location)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.error) {
                        throw new Error(data.error);
                    }
                    
                    if (data.lat && data.lon) {
                        getHealthDataByCoordinates(data.lat, data.lon);
                    } else {
                        throw new Error('Location not found');
                    }
                })
                .catch(error => {
                    handleApiError(error);
                });
        }
    }
    
    // Get health data by coordinates
    function getHealthDataByCoordinates(lat, lon) {
        showLoading();
        
        // Get selected conditions
        const selectedConditions = [];
        healthConditionCheckboxes.forEach(checkbox => {
            if (checkbox.checked) {
                selectedConditions.push(checkbox.value);
            }
        });
        
        // Get selected age group
        const ageGroup = ageGroupSelect.value;
        
        // Get location name from reverse geocoding
        fetch(`/api/reverse-geocode?lat=${lat}&lon=${lon}`)
            .then(response => response.json())
            .then(locationData => {
                // Update location name
                currentLocationData = locationData;
                locationNameElems.forEach(elem => {
                    elem.textContent = `${locationData.name}, ${locationData.country}`;
                });
                
                // Now get health alerts
                const conditionsParam = selectedConditions.length > 0 ? `&conditions=${selectedConditions.join(',')}` : '';
                return fetch(`/api/health-alerts?lat=${lat}&lon=${lon}&age_group=${ageGroup}${conditionsParam}`);
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    throw new Error(data.error);
                }
                
                // Update UI with health data
                updateHealthAlerts(data);
                updateCurrentConditions(data);
                updateAirQuality(data);
                updatePollenLevels(data);
                updateHealthTips(data);
                updateWeatherImpact(data);
                updateWeeklyForecast(data);
                
                // Show toast notification
                showToastNotification('Health data updated successfully!');
                
                // No need to call hideLoading() since the data is loaded
                // hideLoading() function would be defined here if needed
            })
            .catch(error => {
                handleApiError(error);
            });
    }
    
    // Update health data when conditions or age group changes
    function updateHealthData() {
        // Only update if we have location data
        if (currentLocationData.lat && currentLocationData.lon) {
            getHealthDataByCoordinates(currentLocationData.lat, currentLocationData.lon);
        }
    }
    
    // Update health alerts section
    function updateHealthAlerts(data) {
        const alerts = data.alerts || [];
        
        if (alerts.length > 0) {
            let alertsHtml = '<div class="health-alerts">';
            
            alerts.forEach(alert => {
                let severityClass = '';
                let severityIcon = '';
                
                switch (alert.severity) {
                    case 'high':
                        severityClass = 'health-alert-high';
                        severityIcon = 'fas fa-exclamation-circle text-danger';
                        break;
                    case 'moderate':
                        severityClass = 'health-alert-moderate';
                        severityIcon = 'fas fa-exclamation-triangle text-warning';
                        break;
                    default:
                        severityClass = 'health-alert-low';
                        severityIcon = 'fas fa-info-circle text-success';
                }
                
                alertsHtml += `
                    <div class="card mb-3 health-alert-card ${severityClass}">
                        <div class="card-body p-3">
                            <div class="d-flex align-items-center mb-2">
                                <i class="${severityIcon} me-2"></i>
                                <h5 class="mb-0">${alert.title}</h5>
                            </div>
                            <p class="mb-2">${alert.description}</p>
                            <div class="small text-muted">
                                <strong>Affects:</strong> ${alert.affected_groups.join(', ')}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            alertsHtml += '</div>';
            healthAlertsContainer.innerHTML = alertsHtml;
        } else {
            healthAlertsContainer.innerHTML = `
                <div class="alert alert-success" role="alert">
                    <i class="fas fa-check-circle me-2"></i>
                    No significant health alerts for the current conditions.
                </div>
            `;
        }
    }
    
    // Update current conditions section
    function updateCurrentConditions(data) {
        const current = data.current;
        
        const html = `
            <div class="mb-3">
                <div class="d-flex align-items-center mb-3">
                    <i class="${getWeatherIconClass(current.weather[0].main)} fs-1 me-3 ${getTemperatureColorClass(current.temp)}"></i>
                    <div>
                        <div class="fs-2 ${getTemperatureColorClass(current.temp)}">${Math.round(current.temp)}°C</div>
                        <div>${current.weather[0].description}</div>
                    </div>
                </div>
                
                <ul class="list-group list-group-flush">
                    <li class="list-group-item bg-transparent px-0 py-2 d-flex justify-content-between">
                        <span><i class="fas fa-thermometer-half me-2"></i>Feels Like</span>
                        <span>${Math.round(current.feels_like)}°C</span>
                    </li>
                    <li class="list-group-item bg-transparent px-0 py-2 d-flex justify-content-between">
                        <span><i class="fas fa-tint me-2"></i>Humidity</span>
                        <span>${current.humidity}%</span>
                    </li>
                    <li class="list-group-item bg-transparent px-0 py-2 d-flex justify-content-between">
                        <span><i class="fas fa-wind me-2"></i>Wind</span>
                        <span>${current.wind_speed} m/s</span>
                    </li>
                    <li class="list-group-item bg-transparent px-0 py-2 d-flex justify-content-between">
                        <span><i class="fas fa-sun me-2"></i>UV Index</span>
                        <span>${current.uvi}</span>
                    </li>
                </ul>
            </div>
        `;
        
        currentConditionsContainer.innerHTML = html;
    }
    
    // Update air quality section
    function updateAirQuality(data) {
        const aqi = data.air_quality_index || 0;
        const aqiInfo = getAirQualityInfo(aqi);
        
        const html = `
            <div class="text-center mb-3">
                <div class="d-inline-block position-relative">
                    <svg width="120" height="120" viewBox="0 0 120 120">
                        <circle cx="60" cy="60" r="54" fill="none" stroke="#e6e6e6" stroke-width="12" />
                        <circle cx="60" cy="60" r="54" fill="none" stroke="${getAQIColor(aqi)}" stroke-width="12" 
                            stroke-dasharray="339.3" stroke-dashoffset="${339.3 - (339.3 * (aqi / 300))}" 
                            transform="rotate(-90 60 60)" />
                    </svg>
                    <div class="position-absolute top-50 start-50 translate-middle">
                        <div class="fs-2 fw-bold ${aqiInfo.colorClass}">${aqi}</div>
                        <div class="small">${aqiInfo.description}</div>
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <h6>Air Quality Details</h6>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item bg-transparent px-0 py-2 d-flex justify-content-between">
                        <span><i class="fas fa-smog me-2"></i>PM2.5</span>
                        <span>${data.pollutants?.pm2_5 || 'N/A'} μg/m³</span>
                    </li>
                    <li class="list-group-item bg-transparent px-0 py-2 d-flex justify-content-between">
                        <span><i class="fas fa-smog me-2"></i>PM10</span>
                        <span>${data.pollutants?.pm10 || 'N/A'} μg/m³</span>
                    </li>
                    <li class="list-group-item bg-transparent px-0 py-2 d-flex justify-content-between">
                        <span><i class="fas fa-smog me-2"></i>Ozone</span>
                        <span>${data.pollutants?.o3 || 'N/A'} μg/m³</span>
                    </li>
                </ul>
            </div>
        `;
        
        airQualityContainer.innerHTML = html;
    }
    
    // Update pollen levels section
    function updatePollenLevels(data) {
        const pollenLevel = data.pollen_level || 0;
        let pollenDescription = 'Low';
        let pollenColor = '#5CB85C';
        
        if (pollenLevel > 7) {
            pollenDescription = 'Very High';
            pollenColor = '#8E44AD';
        } else if (pollenLevel > 5) {
            pollenDescription = 'High';
            pollenColor = '#D9534F';
        } else if (pollenLevel > 3) {
            pollenDescription = 'Moderate';
            pollenColor = '#F0AD4E';
        }
        
        const html = `
            <div class="text-center mb-3">
                <div class="d-inline-block position-relative">
                    <svg width="120" height="120" viewBox="0 0 120 120">
                        <circle cx="60" cy="60" r="54" fill="none" stroke="#e6e6e6" stroke-width="12" />
                        <circle cx="60" cy="60" r="54" fill="none" stroke="${pollenColor}" stroke-width="12" 
                            stroke-dasharray="339.3" stroke-dashoffset="${339.3 - (339.3 * (pollenLevel / 10))}" 
                            transform="rotate(-90 60 60)" />
                    </svg>
                    <div class="position-absolute top-50 start-50 translate-middle">
                        <div class="fs-2 fw-bold">${pollenLevel}/10</div>
                        <div class="small">${pollenDescription}</div>
                    </div>
                </div>
            </div>
            
            <div class="mt-3">
                <h6>Pollen Types</h6>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item bg-transparent px-0 py-2 d-flex justify-content-between">
                        <span><i class="fas fa-seedling me-2"></i>Tree Pollen</span>
                        <span>${data.pollen_types?.tree || 'Low'}</span>
                    </li>
                    <li class="list-group-item bg-transparent px-0 py-2 d-flex justify-content-between">
                        <span><i class="fas fa-fan me-2"></i>Grass Pollen</span>
                        <span>${data.pollen_types?.grass || 'Low'}</span>
                    </li>
                    <li class="list-group-item bg-transparent px-0 py-2 d-flex justify-content-between">
                        <span><i class="fas fa-cannabis me-2"></i>Weed Pollen</span>
                        <span>${data.pollen_types?.weed || 'Low'}</span>
                    </li>
                </ul>
            </div>
        `;
        
        pollenContainer.innerHTML = html;
    }
    
    // Update health tips section
    function updateHealthTips(data) {
        const tips = data.health_tips || [];
        
        if (tips.length > 0) {
            let tipsHtml = '<ul class="list-group list-group-flush">';
            
            tips.forEach(tip => {
                tipsHtml += `
                    <li class="list-group-item bg-transparent px-0 py-2">
                        <i class="fas fa-check-circle text-success me-2"></i>
                        ${tip}
                    </li>
                `;
            });
            
            tipsHtml += '</ul>';
            healthTipsContainer.innerHTML = tipsHtml;
        } else {
            healthTipsContainer.innerHTML = `
                <div class="alert alert-info" role="alert">
                    <i class="fas fa-info-circle me-2"></i>
                    No specific health tips available for the current conditions.
                </div>
            `;
        }
    }
    
    // Update weather impact section
    function updateWeatherImpact(data) {
        // Temperature impact
        tempImpactContainer.innerHTML = data.temperature_impact || 'No significant temperature impact on health.';
        
        // Pressure impact
        pressureImpactContainer.innerHTML = data.pressure_impact || 'No significant pressure impact on health.';
        
        // UV impact
        uvImpactContainer.innerHTML = data.uv_impact || 'No significant UV impact on health.';
    }
    
    // Handle API errors
    function handleApiError(error) {
        console.error('API Error:', error);
        
        // Show error message in health alerts container
        healthAlertsContainer.innerHTML = `
            <div class="alert alert-danger" role="alert">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error: ${error.message || 'Could not load health data'}
            </div>
        `;
        
        // Show placeholders for other sections
        currentConditionsContainer.innerHTML = `
            <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                Weather data unavailable
            </div>
        `;
        
        airQualityContainer.innerHTML = `
            <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                Air quality data unavailable
            </div>
        `;
        
        pollenContainer.innerHTML = `
            <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                Pollen data unavailable
            </div>
        `;
        
        healthTipsContainer.innerHTML = `
            <div class="alert alert-info" role="alert">
                <i class="fas fa-info-circle me-2"></i>
                Health tips unavailable
            </div>
        `;
        
        // Reset impact containers
        tempImpactContainer.innerHTML = 'Temperature impact data unavailable';
        pressureImpactContainer.innerHTML = 'Pressure impact data unavailable';
        uvImpactContainer.innerHTML = 'UV impact data unavailable';
        
        // Reset forecast table
        forecastTableBody.innerHTML = `
            <tr>
                <td colspan="6" class="text-center text-danger">
                    Forecast data unavailable
                </td>
            </tr>
        `;
    }
    
    // Update weekly forecast section
    function updateWeeklyForecast(data) {
        const forecastDays = data.daily || [];
        
        if (forecastDays.length > 0) {
            let forecastHtml = '';
            
            forecastDays.forEach(day => {
                const date = new Date(day.dt * 1000);
                const dayName = date.toLocaleDateString('en-US', { weekday: 'short' });
                const monthDay = date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                
                // Determine health risk class
                let riskClass = '';
                let riskText = 'Low';
                
                if (day.health_risk >= 7) {
                    riskClass = 'bg-danger text-white';
                    riskText = 'High';
                } else if (day.health_risk >= 4) {
                    riskClass = 'bg-warning';
                    riskText = 'Moderate';
                } else {
                    riskClass = 'bg-success text-white';
                }
                
                // Generate row
                forecastHtml += `
                    <tr>
                        <td>
                            <strong>${dayName}</strong><br>
                            <small class="text-muted">${monthDay}</small>
                        </td>
                        <td>
                            <div class="d-flex align-items-center">
                                <i class="${getWeatherIconClass(day.weather[0].main)} me-2"></i>
                                <span>${Math.round(day.temp.max)}° / ${Math.round(day.temp.min)}°</span>
                            </div>
                        </td>
                        <td>
                            <span class="badge ${getAQIBadgeClass(day.air_quality_index || 0)}">${day.air_quality_index || 'N/A'}</span>
                        </td>
                        <td>
                            <span class="badge ${getPollenBadgeClass(day.pollen_level || 0)}">${day.pollen_level || 'N/A'}</span>
                        </td>
                        <td>
                            <span class="badge ${getUVBadgeClass(day.uvi || 0)}">${day.uvi || 'N/A'}</span>
                        </td>
                        <td>
                            <span class="badge ${riskClass}">${riskText}</span>
                        </td>
                    </tr>
                `;
            });
            
            forecastTableBody.innerHTML = forecastHtml;
        } else {
            forecastTableBody.innerHTML = `
                <tr>
                    <td colspan="6" class="text-center">
                        No forecast data available for this location.
                    </td>
                </tr>
            `;
        }
    }
    
    // Helper function to get AQI badge class
    function getAQIBadgeClass(aqi) {
        if (aqi > 150) return 'bg-danger text-white';
        if (aqi > 100) return 'bg-warning';
        if (aqi > 50) return 'bg-info text-white';
        return 'bg-success text-white';
    }
    
    // Helper function to get pollen badge class
    function getPollenBadgeClass(level) {
        if (level > 7) return 'bg-danger text-white';
        if (level > 4) return 'bg-warning';
        return 'bg-success text-white';
    }
    
    // Helper function to get UV badge class
    function getUVBadgeClass(uv) {
        if (uv > 8) return 'bg-danger text-white';
        if (uv > 5) return 'bg-warning';
        if (uv > 2) return 'bg-info text-white';
        return 'bg-success text-white';
    }
    
    // Helper function to get AQI color
    function getAQIColor(aqi) {
        if (aqi > 300) return '#7E0023'; // Hazardous
        if (aqi > 200) return '#8F3F97'; // Very Unhealthy
        if (aqi > 150) return '#E93F33'; // Unhealthy
        if (aqi > 100) return '#F7A553'; // Unhealthy for Sensitive Groups
        if (aqi > 50) return '#F4D956'; // Moderate
        return '#74BB50'; // Good
    }
    
    // Helper function to get weather icon class
    function getWeatherIconClass(condition) {
        switch (condition.toLowerCase()) {
            case 'clear':
                return 'fas fa-sun';
            case 'clouds':
                return 'fas fa-cloud';
            case 'rain':
                return 'fas fa-cloud-rain';
            case 'drizzle':
                return 'fas fa-cloud-rain';
            case 'thunderstorm':
                return 'fas fa-bolt';
            case 'snow':
                return 'fas fa-snowflake';
            case 'mist':
            case 'smoke':
            case 'haze':
            case 'dust':
            case 'fog':
                return 'fas fa-smog';
            default:
                return 'fas fa-cloud';
        }
    }
    
    // Helper function to get temperature color class
    function getTemperatureColorClass(temp) {
        if (temp > 30) return 'text-danger';
        if (temp > 20) return 'text-warning';
        if (temp > 10) return 'text-success';
        if (temp > 0) return 'text-info';
        return 'text-primary';
    }
    
    // Helper function to get air quality info
    function getAirQualityInfo(aqi) {
        if (aqi > 300) {
            return { description: 'Hazardous', colorClass: 'text-danger' };
        } else if (aqi > 200) {
            return { description: 'Very Unhealthy', colorClass: 'text-danger' };
        } else if (aqi > 150) {
            return { description: 'Unhealthy', colorClass: 'text-danger' };
        } else if (aqi > 100) {
            return { description: 'Unhealthy for Sensitive Groups', colorClass: 'text-warning' };
        } else if (aqi > 50) {
            return { description: 'Moderate', colorClass: 'text-warning' };
        } else {
            return { description: 'Good', colorClass: 'text-success' };
        }
    }
    
    // Toast notification function
    function showToastNotification(message) {
        const toastEl = document.getElementById('healthToast');
        const messageEl = document.getElementById('toastMessage');
        
        if (toastEl && messageEl) {
            messageEl.textContent = message;
            
            // Create Bootstrap toast instance if not already
            const toast = new bootstrap.Toast(toastEl);
            
            // Show the toast
            toast.show();
        }
    }
</script>
{% endblock %}